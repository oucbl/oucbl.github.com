<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.1.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0"><link rel="icon" type="image/png" sizes="32x32" href="/图标32x32.ico?v=7.1.0"><link rel="icon" type="image/png" sizes="16x16" href="/图标16x16.ico?v=7.1.0"><link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.1.0",sidebar:{position:"right",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!0,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="引言偶然发现一个免费ss分享网站，本以为简单的url请求即可获取数据。但是没想到在网站的反爬机制很严格，这反而激起了我的好奇心。不过对于爬虫经验技术来说，是一个很好的学习检验的机会。爬虫整体概况数据获取的核心是围绕2个http请求：方法地址参数备注geturl无响应源码中有可用信息posturl1a,b,c返回加密数据文本主要功能方法绕过DDOS保护（Cloudflare）简单来讲cloudfla"><meta name="keywords" content="SS,Python"><meta property="og:type" content="article"><meta property="og:title" content="一个免费ss网站的数据爬取过程"><meta property="og:url" content="https://oucbl.github.io/blogs/656a7ed5/index.html"><meta property="og:site_name" content="Oucbl"><meta property="og:description" content="引言偶然发现一个免费ss分享网站，本以为简单的url请求即可获取数据。但是没想到在网站的反爬机制很严格，这反而激起了我的好奇心。不过对于爬虫经验技术来说，是一个很好的学习检验的机会。爬虫整体概况数据获取的核心是围绕2个http请求：方法地址参数备注geturl无响应源码中有可用信息posturl1a,b,c返回加密数据文本主要功能方法绕过DDOS保护（Cloudflare）简单来讲cloudfla"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://ww1.sinaimg.cn/large/9d89d613ly1g24pnzo80gj20pa0oywhi.jpg"><meta property="og:image" content="http://ww1.sinaimg.cn/large/9d89d613ly1g24q32f71mj20hi05zaag.jpg"><meta property="og:image" content="http://ww1.sinaimg.cn/large/9d89d613ly1g24qcdqgfgj20v40ilq9l.jpg"><meta property="og:image" content="http://ww1.sinaimg.cn/large/9d89d613ly1g24qxyazfrj20sv08tgpg.jpg"><meta property="og:updated_time" content="2019-04-17T18:21:18.949Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="一个免费ss网站的数据爬取过程"><meta name="twitter:description" content="引言偶然发现一个免费ss分享网站，本以为简单的url请求即可获取数据。但是没想到在网站的反爬机制很严格，这反而激起了我的好奇心。不过对于爬虫经验技术来说，是一个很好的学习检验的机会。爬虫整体概况数据获取的核心是围绕2个http请求：方法地址参数备注geturl无响应源码中有可用信息posturl1a,b,c返回加密数据文本主要功能方法绕过DDOS保护（Cloudflare）简单来讲cloudfla"><meta name="twitter:image" content="http://ww1.sinaimg.cn/large/9d89d613ly1g24pnzo80gj20pa0oywhi.jpg"><link rel="alternate" href="/atom.xml" title="Oucbl" type="application/atom+xml"><link rel="canonical" href="https://oucbl.github.io/blogs/656a7ed5/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>一个免费ss网站的数据爬取过程 | Oucbl</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Oucbl</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">一个狗才程序猿</p></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://oucbl.github.io/blogs/656a7ed5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="保罗"><meta itemprop="description" content><meta itemprop="image" content="/header.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Oucbl"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">一个免费ss网站的数据爬取过程</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-04-14 16:47:41" itemprop="dateCreated datePublished" datetime="2019-04-14T16:47:41+08:00">2019-04-14</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-04-18 02:21:18" itemprop="dateModified" datetime="2019-04-18T02:21:18+08:00">2019-04-18</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/科学上网/" itemprop="url" rel="index"><span itemprop="name">科学上网</span></a></span> </span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">评论数：</span> <a href="/blogs/656a7ed5/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/blogs/656a7ed5/" itemprop="commentCount"></span> </a></span><span id="/blogs/656a7ed5/" class="leancloud_visitors" data-flag-title="一个免费ss网站的数据爬取过程"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">6.8k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">6 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>偶然发现一个免费ss分享网站，本以为简单的url请求即可获取数据。但是没想到在网站的反爬机制很严格，这反而激起了我的好奇心。</p><p>不过对于爬虫经验技术来说，是一个很好的学习检验的机会。</p><h1 id="爬虫整体概况"><a href="#爬虫整体概况" class="headerlink" title="爬虫整体概况"></a>爬虫整体概况</h1><p>数据获取的核心是围绕2个<strong>http请求</strong>：</p><table><thead><tr><th style="text-align:center">方法</th><th style="text-align:center">地址</th><th style="text-align:center">参数</th><th>备注</th></tr></thead><tbody><tr><td style="text-align:center">get</td><td style="text-align:center">url</td><td style="text-align:center">无</td><td>响应源码中有可用信息</td></tr><tr><td style="text-align:center">post</td><td style="text-align:center">url1</td><td style="text-align:center">a,b,c</td><td>返回加密数据文本</td></tr></tbody></table><p><img src="http://ww1.sinaimg.cn/large/9d89d613ly1g24pnzo80gj20pa0oywhi.jpg" alt></p><h1 id="主要功能方法"><a href="#主要功能方法" class="headerlink" title="主要功能方法"></a>主要功能方法</h1><h2 id="绕过DDOS保护（Cloudflare）"><a href="#绕过DDOS保护（Cloudflare）" class="headerlink" title="绕过DDOS保护（Cloudflare）"></a>绕过DDOS保护（Cloudflare）</h2><p>简单来讲cloudflare就是通过js验证访问是否来至真正的web浏览器。</p><p><img src="http://ww1.sinaimg.cn/large/9d89d613ly1g24q32f71mj20hi05zaag.jpg" alt></p><p>如上图所示，访问url 时候一般会进入5秒左右倒计时；请求状态码是503。<br>通过抓包可以看到503请求数秒后跳转一个类似“<a href="https://xxxxx/cdn-cgi/l/chk_jschl?s=xxx”的302请求，成功后即可跳转到期望页面。" target="_blank" rel="noopener">https://xxxxx/cdn-cgi/l/chk_jschl?s=xxx”的302请求，成功后即可跳转到期望页面。</a></p><p><strong>解决方法：</strong>使用任意一个第三方库：cloudflare-scrape 或者 <strong>cloudflare-scrape-js2py</strong><br>这2个库方法通用，安装cloudflare-scrape-js2py方法如下：<br></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/VeNoMouS/cloudflare-scrape-js2py.git</span><br><span class="line">$ sudo python3 setup.py install</span><br></pre></td></tr></table></figure><p></p><p>由于Cloudflare不断改变和强化其保护页面，最初使用的 cloudflare-scrape很快就不能用了，当然可以去提交问题或者查看相关问题的解决方案。<br>我也是各种尝试各种查，不过最后换了 cloudflare-scrape-js2py就解决了问题。</p><p>主要代码如下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session = requests.session()</span><br><span class="line">scraper = cfscrape.create_scraper(sess=session)</span><br><span class="line">scraper = cfscrape.create_scraper(delay=<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">req = scraper.get(url)</span><br><span class="line">html = req.text</span><br></pre></td></tr></table></figure><p></p><h2 id="post中参数a-b-c的解析"><a href="#post中参数a-b-c的解析" class="headerlink" title="post中参数a,b,c的解析"></a>post中参数a,b,c的解析</h2><p>get-&gt;url 返回源码如下图（部分）：<br><img src="http://ww1.sinaimg.cn/large/9d89d613ly1g24qcdqgfgj20v40ilq9l.jpg" alt></p><h3 id="post中参数a-b-c的解析-1"><a href="#post中参数a-b-c的解析-1" class="headerlink" title="post中参数a,b,c的解析"></a>post中参数a,b,c的解析</h3><p>网页源码js中的参数a,b,c<br>解析a,b,c参数主要是依赖正常显示的url的源码中的js代码，如下图重点地方以划出。<br>上图第一个被划线的一句js如下：<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (detect) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="string">'317d2cefb40586a9'</span>;</span><br><span class="line">    <span class="keyword">var</span> b = <span class="string">'e1a5f5499211cbd4'</span>;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="string">'e59ab31720d6cf48'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> b = <span class="string">'e59ab31720d6cf48'</span>;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="string">'317d2cefb40586a9'</span>;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="string">'e1a5f5499211cbd4'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>根据多次观察，可知每次需要取else中的a,b,c的值，代码如下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取页面源码中else&#123;后面的abc的值</span></span><br><span class="line"><span class="comment"># 参数值只能为: 'a' ,'b', 'c'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_var_abc</span><span class="params">(key=<span class="string">'a'</span>)</span>:</span></span><br><span class="line">    <span class="comment"># 反向查找 并截取</span></span><br><span class="line">    ivs = key + <span class="string">"='"</span></span><br><span class="line">    ivl = html.rindex(ivs)</span><br><span class="line">    key = html[ivl + len(ivs): ivl + len(ivs) + <span class="number">16</span>]</span><br><span class="line">    <span class="keyword">return</span> key</span><br></pre></td></tr></table></figure><p></p><p>二维码（base64文本）解码<br>上图中<em>docodeImage</em>方法中第一个参数值如下：</p><p><code>data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFcAAABXAQMAAABLBksvAAAABlBMVEX///8AAABVwtN+AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAq0lEQVQ4jc3Ruw0DIQwGYEcu3B0LRGINOmbKAgm3AKxExxpIXiDXUURxjkgnXXExKe+vPjfgB8DZYkQisEhVPAEGwgCqPUePqQ2cMo8tOPAf/fT+3W6WI6+5bPhlIxjd1bSqePIv0+TtNAPhUjCJ5vW1R5ZIukUaLw0U97LYuWhe9xDIBtLc9+nq3VXNnufMEQaODm7ffzUTL1k1YCr83G596H5fstJA8bnyAVNpDVwJjnB4AAAAAElFTkSuQmCC</code></p><p>这个参数值相当于一个图片的base64编码，其实就是一个二维码。<br>这个二维码是一个长度为16的字符，其实也是post中的一个参数值。</p><p>代码如下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接通过base64字符串解析二维码；获取二维码的值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_qrcode</span><span class="params">(html)</span>:</span></span><br><span class="line">    qrdatas = html.split(<span class="string">'data:image/png;base64,'</span>)[<span class="number">1</span>].split(<span class="string">"',"</span>)[<span class="number">0</span>]</span><br><span class="line">    qrbytes = bytes(qrdatas, encoding=<span class="string">"ascii"</span>)</span><br><span class="line">    decode_result = decode(Image.open(BytesIO(codecs.decode(qrbytes,<span class="string">'base64'</span>))))</span><br><span class="line">    qrvalue =str(decode_result[<span class="number">0</span>].data, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> qrvalue</span><br></pre></td></tr></table></figure><p></p><h3 id="post参数a-b-c值的确定"><a href="#post参数a-b-c值的确定" class="headerlink" title="post参数a,b,c值的确定"></a>post参数a,b,c值的确定</h3><p>上图中的一段省略版的js代码如下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">decodeImage(<span class="string">'data:image/png;base64,iVBORw0KGxx...xxwJjnB4AAAAAElFTkSuQmCC'</span>,</span><br><span class="line">    function(c) &#123;</span><br><span class="line">        $.post(<span class="string">"data.php"</span>,&#123;a:a,b:b,c:encc(c)&#125;,</span><br></pre></td></tr></table></figure><p></p><p>多次观察发现<em>function(key)</em>方法中的参数随机a,b,c任一，而这个随机参数(a/b/c)需要用<strong>二维码的值</strong>来替代。<br><strong>说明：post中的a,b,c的值是依赖js中的a,b,c的值和二维码的值</strong>，所以a,b,c的值要注意以免混淆。</p><p>代码如下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据规则分别求出3种情况下的a,b,c</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_param_abc</span><span class="params">(html)</span>:</span></span><br><span class="line">    a = get_var_abc(key=<span class="string">'a'</span>)</span><br><span class="line">    b = get_var_abc(key=<span class="string">'b'</span>)</span><br><span class="line">    c = get_var_abc(key=<span class="string">'c'</span>)</span><br><span class="line">    symbolKey = html.split(<span class="string">'data:image/png;base64,'</span>)[<span class="number">1</span>].split(<span class="string">"function("</span>)[<span class="number">1</span>][:<span class="number">1</span>]</span><br><span class="line">    print(<span class="string">'symbolKey'</span>,symbolKey)</span><br><span class="line">    print(symbolKey==<span class="string">'a'</span>,symbolKey==<span class="string">'b'</span>,symbolKey==<span class="string">'c'</span>)</span><br><span class="line">    <span class="keyword">if</span> symbolKey == <span class="string">'a'</span>:</span><br><span class="line">        a = decode_qrcode(html)</span><br><span class="line">    <span class="keyword">elif</span> symbolKey == <span class="string">'b'</span>:</span><br><span class="line">        b = decode_qrcode(html)</span><br><span class="line">    <span class="keyword">elif</span> symbolKey == <span class="string">'c'</span>:</span><br><span class="line">        c = decode_qrcode(html)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># js2py.translate_file('encc.min.js', 'encc.py')</span></span><br><span class="line">    <span class="keyword">from</span> encc <span class="keyword">import</span> PyJsHoisted_encc_</span><br><span class="line">    c = PyJsHoisted_encc_(c).value</span><br><span class="line">    print(<span class="string">'\n%s\n%s\n%s'</span>% (a,b,c))</span><br><span class="line">    <span class="keyword">return</span> a,b,c</span><br></pre></td></tr></table></figure><p></p><h3 id="post参数c的值的加密"><a href="#post参数c的值的加密" class="headerlink" title="post参数c的值的加密"></a>post参数c的值的加密</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$.post(<span class="string">"data.php"</span>, &#123;</span><br><span class="line">    a: a,</span><br><span class="line">    b: b,</span><br><span class="line">    c: encc(c)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>这一行是js中post的请求，是固定的对参数c进行加密，网站中的js加密算法比较清晰。<br>这时的思路有3种：</p><ol><li>直接通过python执行js代码；</li><li>第三方（库）自动代码转换（ js-&gt;python ）；</li><li>根据js中的加密思想，手动进行python编码；</li></ol><p>比较推荐前2种方法，毕竟第3种手动转码太难太耗时间。<br>这里推荐2个执行js的库：<strong>Js2Py</strong>，PyExeJs<br>本文使用的是Js2Py，这个强大的库可以直接执行js代码和转换js文件。</p><p>所以这行js对应的python代码为：<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a,b,c = get_param_abc(html)</span><br><span class="line"></span><br><span class="line">#post提交a,b,c,得到密文</span><br><span class="line">payload = &#123;<span class="string">'a'</span>:a,<span class="string">'b'</span>:b,<span class="string">'c'</span>:c&#125;</span><br><span class="line">session.cookies = scraper.cookies  # 必须带上cookies</span><br><span class="line">req = scraper.post(url2,data=payload)</span><br><span class="line">msg = req.text</span><br></pre></td></tr></table></figure><p></p><h2 id="AES加密数据解码"><a href="#AES加密数据解码" class="headerlink" title="AES加密数据解码"></a>AES加密数据解码</h2><h3 id="确定AES加密模式（弃用）"><a href="#确定AES加密模式（弃用）" class="headerlink" title="确定AES加密模式（弃用）"></a>确定AES加密模式（弃用）</h3><p>最初是想用判断语句指定加密模式参数，但有幸后来看到大牛的好方法。<br>不过有一个小点需要说明一下，就是可以从js源码中分析出来加密参数；<br>如上节图上被括起来的js文本如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//js eval加密文本</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="function"><span class="keyword">function</span>(<span class="params">p,a,c,k,e,d</span>)</span>&#123;e=<span class="function"><span class="keyword">function</span>(<span class="params">c</span>)</span>&#123;<span class="keyword">return</span>(c&lt;a?<span class="string">""</span>:e(<span class="built_in">parseInt</span>(c/a)))+((c=c%a)&gt;<span class="number">35</span>?<span class="built_in">String</span>.fromCharCode(c+<span class="number">29</span>):c.toString(<span class="number">36</span>))&#125;;<span class="keyword">if</span>(!<span class="string">''</span>.replace(<span class="regexp">/^/</span>,<span class="built_in">String</span>))&#123;<span class="keyword">while</span>(c--)d[e(c)]=k[c]||e(c);k=[<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">return</span> d[e]&#125;];e=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span><span class="string">'\\w+'</span>&#125;;c=<span class="number">1</span>;&#125;;<span class="keyword">while</span>(c--)<span class="keyword">if</span>(k[c])p=p.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'\\b'</span>+e(c)+<span class="string">'\\b'</span>,<span class="string">'g'</span>),k[c]);<span class="keyword">return</span> p;&#125;(<span class="string">'1 2=\'4\'+\'h\'+\'8\'+\'9\'+\'a\';1 5=\'3\'+\'6\';1 7=0.b.g(d,i,&#123;c:e,2:0.2.4,f:0.5.3&#125;);'</span>,<span class="number">19</span>,<span class="number">19</span>,<span class="string">'CryptoJS|var|mode|Pkcs7|CBC|pad|ZeroPadding|dec|CTR|ECB|OFB|AES|iv||y|padding|decrypt|CFB|x'</span>.split(<span class="string">'|'</span>),<span class="number">0</span>,&#123;&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">//js 解密（解压缩）后的文本</span></span><br><span class="line"><span class="keyword">var</span> mode = <span class="string">'CBC'</span> + <span class="string">'CFB'</span> + <span class="string">'CTR'</span> + <span class="string">'ECB'</span> + <span class="string">'OFB'</span>;</span><br><span class="line"><span class="keyword">var</span> pad = <span class="string">'Pkcs7'</span> + <span class="string">'ZeroPadding'</span>;</span><br><span class="line"><span class="keyword">var</span> dec = CryptoJS.AES.decrypt(d, x, &#123;</span><br><span class="line">    iv: y,</span><br><span class="line">    mode: CryptoJS.mode.CBC,</span><br><span class="line">    padding: CryptoJS.pad.Pkcs7</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="免判断加密模式并解密（推荐）"><a href="#免判断加密模式并解密（推荐）" class="headerlink" title="免判断加密模式并解密（推荐）"></a>免判断加密模式并解密（推荐）</h3><p>中间和朋友电话闲聊中问过一句模式的选择，朋友只是说模式不重要；当时就觉得应该有一种遍历类型的解法。</p><p>根据js代码可知：下面python代码的<em>decrypt_data</em>方法的参数<em>key，iv</em>分别对应post参数的<em>a，b</em>；即：<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">endata = base64.b64decode(msg)</span><br><span class="line">key = bytes(a,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">iv  = bytes(b,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line">ssdata = decrypt_data(key, iv, endata)</span><br></pre></td></tr></table></figure><p></p><p>由此对应的python代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""解密数据得到ss信息，返回list对象"""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_data</span><span class="params">(key, iv, endata)</span>:</span></span><br><span class="line">    ctr = Counter.new(<span class="number">128</span>, initial_value=int(binascii.hexlify(iv), <span class="number">16</span>))</span><br><span class="line">    modes = [</span><br><span class="line">        AES.new(key, AES.MODE_ECB),</span><br><span class="line">        AES.new(key, AES.MODE_CBC, iv),</span><br><span class="line">        AES.new(key, AES.MODE_OFB, iv),</span><br><span class="line">        AES.new(key, AES.MODE_CTR, counter=ctr),</span><br><span class="line">        AES.new(key, AES.MODE_CFB, iv, segment_size=<span class="number">128</span>)</span><br><span class="line">    ]</span><br><span class="line">    rtdatas = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> mode <span class="keyword">in</span> modes:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            dec = mode.decrypt(endata).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            print(dec[<span class="number">-200</span>:])     <span class="comment"># 解密后文本结尾可能存在'\0'</span></span><br><span class="line">            dec = dec.rstrip(<span class="string">'\0'</span>)  <span class="comment"># 去除结尾空白符'\0'</span></span><br><span class="line">            rtdatas = json.loads(dec)[<span class="string">'data'</span>]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> rtdatas</span><br></pre></td></tr></table></figure><p>网站的加密模式是5种的随机的一种，其中可能遇到CFB模式中会报错，后来发现pycryto的版本问题，安装pycrytodome即可。</p><h3 id="解码数据并测延时"><a href="#解码数据并测延时" class="headerlink" title="解码数据并测延时"></a>解码数据并测延时</h3><p>post密文解密后是json的文本，下图是格式化片段：</p><p><img src="http://ww1.sinaimg.cn/large/9d89d613ly1g24qxyazfrj20sv08tgpg.jpg" alt></p><p>账号的处理及测试可参考github大神的方法：<strong><a href="https://github.com/free-ss/free-ss.site/blob/master/%E6%A3%80%E6%B5%8B%E7%A8%8B%E5%BA%8F%E4%BB%8B%E7%BB%8D.md" target="_blank" rel="noopener">检测程序介绍</a></strong></p><h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>对于这个网站学习挺好，其他就不要多想了。</p><h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><h3 id="本文相关库"><a href="#本文相关库" class="headerlink" title="本文相关库"></a>本文相关库</h3><p>python=3.6.5<br>brotli=1.0.7<br>cfscrape=2.0.3<br>requests=2.21.0<br>Js2Py=0.60<br>Pillow=5.1.0 # Pillow(PIL Fork)<br>cryptodemo=0.0.1</p><h3 id="第三方开源库"><a href="#第三方开源库" class="headerlink" title="第三方开源库"></a>第三方开源库</h3><p><a href="https://github.com/Anorov/cloudflare-scrape" target="_blank" rel="noopener">https://github.com/Anorov/cloudflare-scrape</a><br><a href="https://github.com/VeNoMouS/cloudflare-scrape-js2py" target="_blank" rel="noopener">https://github.com/VeNoMouS/cloudflare-scrape-js2py</a></p><p><a href="https://github.com/PiotrDabkowski/Js2Py" target="_blank" rel="noopener">https://github.com/PiotrDabkowski/Js2Py</a></p><h3 id="在线测试工具"><a href="#在线测试工具" class="headerlink" title="在线测试工具"></a>在线测试工具</h3><p>在线二维码-Convert Your Base64 to Image<br><a href="https://codebeautify.org/base64-to-image-converter" target="_blank" rel="noopener">https://codebeautify.org/base64-to-image-converter</a><br>js在线解密/美化<br><a href="https://tool.lu/js/" target="_blank" rel="noopener">https://tool.lu/js/</a><br>在线json解析<br><a href="https://www.sojson.com/" target="_blank" rel="noopener">https://www.sojson.com/</a></p><hr><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>binascii.Error: Incorrect padding, even when string length is multiple of 4<br><a href="https://stackoverflow.com/questions/45879045/binascii-error-incorrect-padding-even-when-string-length-is-multiple-of-4" target="_blank" rel="noopener">https://stackoverflow.com/questions/45879045/binascii-error-incorrect-padding-even-when-string-length-is-multiple-of-4</a></p><p>python字符串str和字节数组相互转化<br><a href="https://www.cnblogs.com/hhh5460/p/5243305.html" target="_blank" rel="noopener">https://www.cnblogs.com/hhh5460/p/5243305.html</a></p><p>Python3操作二维码图片<br><a href="http://blog.niuhemoon.xyz/pages/2018/04/27/Python3-QRcode/" target="_blank" rel="noopener">http://blog.niuhemoon.xyz/pages/2018/04/27/Python3-QRcode/</a></p><p>关于xxx网站js加密算法的研究<br><a href="https://github.com/gcdd1993/analyzeSS" target="_blank" rel="noopener">https://github.com/gcdd1993/analyzeSS</a></p><p>Python爬取某站科学上网帐号(5.15更新)<br><a href="https://mtaoist.xyz/2018/04/07/python-getss/" target="_blank" rel="noopener">https://mtaoist.xyz/2018/04/07/python-getss/</a><br>xiaoTaoist：Auto-Shadowsocks项目<br><a href="https://github.com/xiaoTaoist/Auto-Shadowsocks" target="_blank" rel="noopener">https://github.com/xiaoTaoist/Auto-Shadowsocks</a></p></div><div><div id="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/pay.png" alt="保罗 微信-支付宝"><p>微信-支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/SS/" rel="tag"># SS</a> <a href="/tags/Python/" rel="tag"># Python</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/blogs/58bb5a76/" rel="next" title="ubuntu+java+imgbb图床脚本"><i class="fa fa-chevron-left"></i> ubuntu+java+imgbb图床脚本</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/header.jpg" alt="保罗"><p class="site-author-name" itemprop="name">保罗</p><div class="site-description motion-element" itemprop="description"></div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">2</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">2</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/oucbl" title="GitHub &rarr; https://github.com/oucbl" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:jiabaoluo@stu.ouc.edu.cn" title="E-Mail &rarr; mailto:jiabaoluo@stu.ouc.edu.cn" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#引言"><span class="nav-text">引言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#爬虫整体概况"><span class="nav-text">爬虫整体概况</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#主要功能方法"><span class="nav-text">主要功能方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#绕过DDOS保护（Cloudflare）"><span class="nav-text">绕过DDOS保护（Cloudflare）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#post中参数a-b-c的解析"><span class="nav-text">post中参数a,b,c的解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#post中参数a-b-c的解析-1"><span class="nav-text">post中参数a,b,c的解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post参数a-b-c值的确定"><span class="nav-text">post参数a,b,c值的确定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post参数c的值的加密"><span class="nav-text">post参数c的值的加密</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AES加密数据解码"><span class="nav-text">AES加密数据解码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#确定AES加密模式（弃用）"><span class="nav-text">确定AES加密模式（弃用）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#免判断加密模式并解密（推荐）"><span class="nav-text">免判断加密模式并解密（推荐）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解码数据并测延时"><span class="nav-text">解码数据并测延时</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#最后"><span class="nav-text">最后</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#相关资源"><span class="nav-text">相关资源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本文相关库"><span class="nav-text">本文相关库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第三方开源库"><span class="nav-text">第三方开源库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在线测试工具"><span class="nav-text">在线测试工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-text">参考</span></a></li></ol></li></ol></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-snowflake-o"></i> </span><span class="author" itemprop="copyrightHolder">Oucbl</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="站点总字数">13k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">12 分钟</span></div><div style="display:none"><script type="text/javascript" src="https://s5.cnzz.com/z_stat.php?id=1277143533&web_id=1277143533"></script></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.1.0"></script><script src="/js/motion.js?v=7.1.0"></script><script src="/js/affix.js?v=7.1.0"></script><script src="/js/schemes/pisces.js?v=7.1.0"></script><script src="/js/scrollspy.js?v=7.1.0"></script><script src="/js/post-details.js?v=7.1.0"></script><script src="/js/next-boot.js?v=7.1.0"></script><script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"hdYBVyXyQmUYBUSiz1fS5Bam-gzGzoHsz",appKey:"o9URcXSULHW5I3SB00xVB277",placeholder:"Just go go",avatar:"mm",meta:guest,pageSize:"10",visitor:!1,lang:"zh-cn"})</script><script>function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! More info at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + 'hdYBVyXyQmUYBUSiz1fS5Bam-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': 'hdYBVyXyQmUYBUSiz1fS5Bam-gzGzoHsz',
                'X-LC-Key': 'o9URcXSULHW5I3SB00xVB277',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });</script></body></html>